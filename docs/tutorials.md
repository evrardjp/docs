# FuseML Tutorials

Testing FuseML is simpler than one may think. Let's showcase some use cases.

## Example 1 - A simple logistic regression

Let's look at the example for MLflow model, being trained by MLflow and served with KFServing.
We assume both FuseML infrastructure and FuseML command-line are already installed, if not please check first the [quick start](quickstart.md) section.

**1.** Set the FUSEML_SERVER_URL environment variable to point to the server URL:

The fuseml server URL is printed out by the installer during the FuseML installation. If you missed it, you can retrieve it at any time with the following command:

```bash
export FUSEML_SERVER_URL=http://$(kubectl get VirtualService -n fuseml-core fuseml-core -o jsonpath="{.spec.hosts[0]}")
```

**2.** Get the example code

```bash
git clone https://github.com:fuseml/examples.git
cd fuseml-examples
```

**3.** Under models/mlflow-wines directory there is the example MLflow project. It's only slightly modified example based on the upstream MLflow public example [here](https://mlflow.org/docs/latest/tutorials-and-examples/tutorial.html).

**4.** Register the codeset

```bash
fuseml codeset register --name "mlflow-test" --project "mlflow-project-01" codesets/mlflow-wines
```

**5.** Check the result directly on the GITEA website. Login on `http://gitea.<YOUR FUSEML URL>` using username `dev` and password `changeme`. You should find a new organization named `mlflow-project-01` and a repo named `mlflow-test`.

**6.** Update the example to fit your setup

The workflow definition example has some hardcoded values that need to be changed for your specific environment. Namely, see the AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY values: these are the credentials to the S3 based minio store that was installed to your cluster by fuseml-installer.

To get these values from your cluster setup, run

```bash
export ACCESS=$(kubectl get secret -n fuseml-workloads mlflow-minio -o json| jq -r '.["data"]["accesskey"]' | base64 -d)
export SECRET=$(kubectl get secret -n fuseml-workloads mlflow-minio -o json| jq -r '.["data"]["secretkey"]' | base64 -d)
```

Now replace the original values in the pipeline-01.yaml example. You can do it by editing the file manually or by running following command:

```
sed -i -e "/AWS_ACCESS_KEY_ID/{N;s/value: [^ \t]*/value: $ACCESS/}" pipelines/pipeline-01.yaml
sed -i -e "/AWS_SECRET_ACCESS_KEY/{N;s/value: [^ \t]*/value: $SECRET/}" pipelines/pipeline-01.yaml
```

**7.** Create a workflow

Use the modified example workflow definition:

```bash
fuseml workflow create pipelines/pipeline-01.yaml
```

**8.** Assign the codeset to workflow

```bash
fuseml workflow assign --name mlflow-sklearn-e2e --codeset-name mlflow-test --codeset-project mlflow-project-01
``` 

**9.** Monitor the workflow from the command-line

Now that the Workflow is assigned to the Codeset, a new workflow run was created. To watch the workflow progress, check "workflow run" with:

```bash
fuseml workflow list-runs --name mlflow-sklearn-e2e
```

This command shows you detailed information about running workflow. You may also follow the URL value under output section to see relevant information about the underlying Tekton PipelineRun which implements the workflow run. Once the run is succeeded, a new FuseML application will be created.

**10.** Access the prediction service

Once the application is created, check the applications list with:

```bash
fuseml application list
```

This should produce output similar to this one (notice the fake "example.io" domain here):

- name: mlflow-project-01-mlflow-test
    type: predictor
    description: Application generated by mlflow-sklearn-e2e workflow
    url: http://mlflow-project-01-mlflow-test.fuseml-workloads.example.io/v2/models/mlflow-project-01-mlflow-test/infer
    workflow: mlflow-sklearn-e2e

Use the URL from the new application to run the prediction. First, prepare the data

```bash
cat > data.json
{
    "inputs": [
    {
        "name": "input-0",
        "shape": [1, 11],
        "datatype": "FP32",
        "data": [
        [12.8, 0.029, 0.48, 0.98, 6.2, 29, 7.33, 1.2, 0.39, 90, 0.86]
        ]
    }
    ]
}
```

and pass the data to the the prediction service. Assuming the service URL was saved to PREDICTOR_URL, call:

```bash
curl -d @data.json http://$PREDICTOR_URL

The output should look like

{
    "model_name":"mlflow-project-01-mlflow-test",
    "model_version":null,
    "id":"44d5d037-052b-49b6-aace-1c5346a35004",
    "parameters":null,
    "outputs": [
    {
        "name":"predict",
        "shape":[1],
        "datatype":"FP32",
        "parameters":null,
        "data": [ 6.486344809506676 ]
    }
    ]
}
```

**10.** (Optional) Use the webapp example

Alternatively one may use a simple app we developed using [streamlit](https://streamlit.io/).

Assuming streamlit is already installed just run:

```bash
streamlit run https://raw.githubusercontent.com/fuseml/examples/main/webapps/wineapp.py
```

Follow the instructions presented in the webpage to make your own prediction with the FuseML application you just deployed.
